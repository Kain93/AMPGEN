#include <Servo.h>
#include <string.h>
using namespace std;
 
char unitID_in[10];
char command_in[10];
char data_in[10];
char data_in_res[10];
int data_in_int;
int data_in_int_res;
 
int analogID;
int digitalID;
int i=0;
char buffer[40];
int j=-1;

volatile int state = LOW;

//ISR(USART_RX_vect)
//{
    //текст программы обработки прерывания
    
//}

//ISR(USART_TX_vect)
//{
    //текст программы обработки прерывания
    
//}

void digitalPWM () {
  
if ((String)unitID_in == "009"||(String)unitID_in == "010") {
  
  if((String)unitID_in == "009") {digitalID = 9;}
  if((String)unitID_in == "010") {digitalID = 10;}
       
      if ((String)command_in == "active"){
        
          data_in_int=atoi(data_in);
          data_in_int_res=atoi(data_in_res);
          
          //SetPinFrequency(digitalID, data_in_int_res);
          //pwmWrite(digitalID, data_in_int);
      
          //digitalWrite(2, HIGH);
          
          Serial.print("Unit ");
          Serial.print(unitID_in);
          Serial.print(" PWM ");
          Serial.print(command_in);
          Serial.print("\n");
          Serial.print("power: ");
          Serial.print(data_in);      
          Serial.print("\n");
          Serial.print("frequency: ");
          Serial.print(data_in_res);      
          Serial.print("\n");
      
          delay(200);
          //digitalWrite(2, LOW);
      
      }
      
      if ((String)command_in == "deactive"){
        
          analogWrite(digitalID, 0);
          
          //digitalWrite(2, HIGH);
          
          Serial.print("Unit ");
          Serial.print(unitID_in);
          Serial.print(" PWM ");
          Serial.print(command_in);
          Serial.print("\n");
      
          delay(200);
          //digitalWrite(2, LOW);
      
      }   
     
      memset (unitID_in, 0, 10);
      memset (command_in, 0, 10);
      memset (data_in, 0, 10);
      memset (data_in_res, 0, 10);
      memset (buffer, 0, 20);      
           
    }
}

void digitalRele () {
     //if((String)unitID_in == "004") {digitalWrite(13, state);}
     if ((String)unitID_in == "004"||(String)unitID_in == "007"||(String)unitID_in == "008"||(String)unitID_in == "012") {
       
      if((String)unitID_in == "004") {digitalID = 4;}
      if((String)unitID_in == "007") {digitalID = 7;}
      if((String)unitID_in == "008") {digitalID = 8;}
      if((String)unitID_in == "012") {digitalID = 12;}
       
      if ((String)command_in == "active"){
        
          digitalWrite(digitalID, LOW);
      
          digitalWrite(2, HIGH);
          
          
          
          Serial.print("Unit ");
          Serial.print(unitID_in);
          Serial.print(" RELE ");
          Serial.print(command_in);
          Serial.print("\n");     

          delay(200);
          digitalWrite(2, LOW);

      }
      
      if ((String)command_in == "deactive") {
        
          digitalWrite(digitalID, HIGH);
      
          digitalWrite(2, HIGH);
          
          Serial.print("Unit ");
          Serial.print(unitID_in);
          Serial.print(" RELE ");
          Serial.print(command_in);
          Serial.print("\n");
      
          delay(200);
          digitalWrite(2, LOW);
      
      }   
      
      memset (unitID_in, 0, 10);
      memset (command_in, 0, 10);
      memset (buffer, 0, 40);      
           
    }
  
}

void setup()
{
  // Открываем порт передачи данных
  Serial.begin(9600);
  
  // Открываем пины
  pinMode(2, OUTPUT);
  pinMode(3, OUTPUT);
  pinMode(4, OUTPUT);
  pinMode(5, OUTPUT);
  pinMode(6, OUTPUT);
  pinMode(7, OUTPUT);
  pinMode(8, OUTPUT);
  pinMode(9, OUTPUT);
  pinMode(10, OUTPUT);
  pinMode(11, OUTPUT);
  pinMode(12, OUTPUT);
  pinMode(13, OUTPUT);

    
   if(j<0) {
    digitalWrite(4, HIGH);
    digitalWrite(7, HIGH);
    digitalWrite(8, HIGH);
    digitalWrite(12, HIGH);
    
    j=1;
   }
  
}
 
void loop()
  {         
   

 
    digitalWrite(13, LOW);
 
    // Считываем данные порта
    
    while(Serial.available()>0) {

       delay(100);
      
       // Заполняем буфер
       while( Serial.available() && i < 40) {
        
         buffer[i++] = Serial.read();
       }
     // Закрываем массив
       buffer[i++]='\0';
 
  
  // Отправляем обратно то что пришло
      
      digitalWrite(2, HIGH);
      
      Serial.print("Buffer ");
      Serial.print(buffer);
      Serial.print("\n");
  
      // Разбираем буфер на части     
      while(i>0) {      
      sscanf(buffer, "%[^','],%[^','],%[^','],%[^',']", &unitID_in, &command_in, &data_in, &data_in_res);
      i=0;
             }

      // Отправляем то что разобрано
      
      Serial.print("Unit ");
      Serial.print(unitID_in);
      Serial.print(" command ");
      Serial.print(command_in);
      Serial.print("  ");
      Serial.print("data: ");
      Serial.print(data_in);      
      Serial.print("  ");
      Serial.print("data_res: ");
      Serial.print(data_in_res);      
      Serial.print("\n");
      
      //delay(200);
      digitalWrite(2, LOW);
   }     
    // Исполнительная часть  
  
    digitalPWM();
    digitalRele();
    

}
